import sys 
import sextractorObject
import numpy as np

if __name__ == "__main__":
    cat_dir, cat_root = sys.argv[1:]
    #print 'args = ' + str(args) 
    #pisco_dir = '/Users/sasha/Documents/Harvard/physics/stubbs/PISCO/2018_06_20/'
    #cat_root = 'proc_SPT-CL0959-2801_35_'
    print 'Looking for catalogues of form ' + cat_dir + cat_root + '[filter].cat'

    filter_strs = ['g','r','i','z']
    n_filters = len(filter_strs) 
    sex_cats = [cat_dir + cat_root + filter_str + '.cat' for filter_str in filter_strs]

    print 'Reading in sextractor catalogs...'
    PySex_objects_by_filter = [sextractorObject.PySex(cat) for cat in sex_cats]

    mag_cut = np.inf
    #0     The object has neighbors, bright and close enough to significantly bias the photometry, or bad pixels (more than 10% of the integrated area affected).
    #1     The object was originally blended with another one.
    #2     At least one pixel of the object is saturated (or very close to).
    #3     The object is truncates (to close to an image boundary).
    #4     Object's aperture data are incomplete or corrupted.
    #5     Object's isophotal data are incomplete or corrupted.
    #6     A memory overflow occurred during deblending.
    #7     A memory overflow occurred during extraction.
    flags_to_use = [2 ** flag_num for flag_num in [2, 3, 4, 5, 6, 7]]

    print 'Trimming object lists...'
    [PySex_objects.trimObjectList(cut_by_mag = 1, mag_cut = mag_cut, cut_by_flags = 1, flag_cuts = flags_to_use) for PySex_objects in PySex_objects_by_filter]

    print 'Generating ellipse region files...'
    [PySex_objects_by_filter[i].generateRegionFile(file_name = cat_dir + cat_root + filter_strs[i] + '_ellipse.reg', color = 'green',  region_type = 'ellipse') for i in range(n_filters)]
    print 'Generating circle region files...'
    [PySex_objects_by_filter[i].generateRegionFile(file_name = cat_dir + cat_root + filter_strs[i] + '_circle.reg', color = 'red',  region_type = 'circle') for i in range(n_filters)]
    print 'Generating ellipticity plots...'
    sextractorObject.makeGroupedEllipticityPlots(PySex_objects_by_filter, show = 0, save = 1, save_dir = cat_dir, file_name = cat_root + '_ellipticity_contours_plots.png', figsize = [1500.0 / 100.0, 2400.0 / 100.0], plot_contours = 1, plot_arrows = 0)
    sextractorObject.makeGroupedEllipticityPlots(PySex_objects_by_filter, show = 0, save = 1, save_dir = cat_dir, file_name = cat_root + '_ellipticity_arrows_plots.png', figsize = [1500.0 / 100.0, 2400.0 / 100.0], plot_contours = 0, plot_arrows = 1)
    sextractorObject.makeGroupedEllipticityPlots(PySex_objects_by_filter, show = 0, save = 1, save_dir = cat_dir, file_name = cat_root + '_ellipticity_contoursAndArrows_plots.png', figsize = [1500.0 / 100.0, 2400.0 / 100.0], plot_contours = 1, plot_arrows = 1)
    

    
